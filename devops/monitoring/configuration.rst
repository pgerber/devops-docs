########################
Monitoring Configuration
########################

This document describes how Nice installations running on OpenShift are
monitored.

OpenShift Routes
----------------

Checks are defined in `common.yaml`_. These definitions are generated by the
script described below. The script uses annotations on the :term:`routes
<route>` as basis.

The following annotations can be used to configure monitoring:

================================ ==============================================
 Annotation                       Description
================================ ==============================================
 ``monitoring/enabled``           Whether a check should be created for the
                                  route. Defaults to "true".
 ``monitoring/path``              Path to monitor. Defaults to "/".

                                  For Nice installations "/status-tocco" is
                                  monitored.
 ``monitoring/alert_customer``    Whether Tocco (the customer) should get
                                  alerts. Currently alerts are send to
                                  admin\@tocco.ch. Defaults to "true".
 ``monitoring/alert_vshn``        Whether VSHN should get an alert. Defaults
                                  to false.

                                  Not currently used.
================================ ==============================================

Annotations can be updated using ``oc edit route ${ROUTE}`` or using ``oc annotate``::

    oc annotate route/${ROUTE} monitoring/enabled=true monitoring/alert_customer=false


.. _monitoring-generate-checks:

Generating Definitions for Checks
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

As mentioned above, all checks are defined in `common.yaml`_ and can be generated
based on annotations on the routes.

Generating the configuration:

#. install *appuio_routes_monitoring*::

     pip3 install --user --upgrade appuio_routes_monitoring

#. update repository::

     git pull --rebase

#. remove existing routes::

     awk '/^profile_icinga2::hiera_httpchecks:$/ { exit; } { print $0; }' common.yaml >common.yaml.tmp
     mv common.yaml.tmp common.yaml

#. login on OpenShift console::

     oc login

#. run *generate_monitoring_check*::

     generate_monitoring_check >>common.yaml

   .. hint::

       If $PATH isn't configured correctly on your system, try using an absolute path. It's likely:
       ``~/.local/bin/generate_monitoring_check``.

#. verify change makes sense, commit and push::

     git add common.yaml
     git diff --staged
     git commit -m 'Update HTTP checks'
     git push


.. _common.yaml: https://git.vshn.net/tocco/tocco_hieradata/blob/master/common.yaml
.. Incinga Web Interface: https://tocco-docs.readthedocs.io/en/latest/devops/monitoring/icinga.html
